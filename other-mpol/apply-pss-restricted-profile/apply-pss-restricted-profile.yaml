apiVersion: policies.kyverno.io/v1alpha1
kind: MutatingPolicy
metadata:
  name: apply-pss-restricted-profile
  annotations:
    policies.kyverno.io/title: Apply PSS Restricted Profile
    policies.kyverno.io/category: Other, PSP Migration
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Pod Security Standards define the fields and their options which
      are allowable for Pods to achieve certain security best practices. While
      these are typically validation policies, workloads will either be accepted or
      rejected based upon what has already been defined. It is also possible to mutate
      incoming Pods to achieve the desired PSS level rather than reject. This policy
      sets all the fields necessary to pass the PSS Restricted profile. Note that it does
      not attempt to remove non-compliant volumes and volumeMounts. Additional policies
      may be employed for this purpose.
spec:
  matchConstraints:
    resourceRules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["pods"]
      - apiGroups: ["apps"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["deployments", "statefulsets", "daemonsets"]
      - apiGroups: ["batch"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["jobs", "cronjobs"]
  
  variables:
    # Determine the base path for the pod spec based on resource kind
    - name: podSpecPath
      expression: |
        object.kind == "Pod" ? "/spec" :
        object.kind == "CronJob" ? "/spec/jobTemplate/spec/template/spec" :
        "/spec/template/spec"
    
    # Get the actual pod spec object
    - name: podSpec
      expression: |
        object.kind == "Pod" ? object.spec :
        object.kind == "CronJob" ? object.spec.jobTemplate.spec.template.spec :
        object.kind in ["Deployment", "StatefulSet", "DaemonSet", "Job"] ? object.spec.template.spec :
        {}
  
  mutations:
    # Mutation 1: Set pod-level security context
    - patchType: JSONPatch
      jsonPatch:
        expression: |
          has(variables.podSpec.securityContext) ?
          [
            JSONPatch{
              op: "add",
              path: variables.podSpecPath + "/securityContext/seccompProfile",
              value: dyn({"type": "RuntimeDefault"})
            },
            JSONPatch{
              op: "add",
              path: variables.podSpecPath + "/securityContext/runAsNonRoot",
              value: dyn(true)
            },
            JSONPatch{
              op: "add",
              path: variables.podSpecPath + "/securityContext/runAsUser",
              value: dyn(1000)
            },
            JSONPatch{
              op: "add",
              path: variables.podSpecPath + "/securityContext/runAsGroup",
              value: dyn(3000)
            },
            JSONPatch{
              op: "add",
              path: variables.podSpecPath + "/securityContext/fsGroup",
              value: dyn(2000)
            }
          ] :
          [
            JSONPatch{
              op: "add",
              path: variables.podSpecPath + "/securityContext",
              value: dyn({
                "seccompProfile": dyn({"type": "RuntimeDefault"}),
                "runAsNonRoot": dyn(true),
                "runAsUser": dyn(1000),
                "runAsGroup": dyn(3000),
                "fsGroup": dyn(2000)
              })
            }
          ]
    
    # Mutation 2: Create securityContext object for all containers that don't have one
    - patchType: JSONPatch
      jsonPatch:
        expression: |
          variables.podSpec.containers.map(c, 
            !has(c.securityContext) ?
            JSONPatch{
              op: "add",
              path: variables.podSpecPath + "/containers/" + string(variables.podSpec.containers.indexOf(c)) + "/securityContext",
              value: dyn({})
            } : null
          ).filter(p, p != null)
    
    # Mutation 3: Set privileged=false for all containers
    - patchType: JSONPatch
      jsonPatch:
        expression: |
          variables.podSpec.containers.map(c, 
            JSONPatch{
              op: "add",
              path: variables.podSpecPath + "/containers/" + string(variables.podSpec.containers.indexOf(c)) + "/securityContext/privileged",
              value: dyn(false)
            }
          )
    
    # Mutation 4: Drop all capabilities for all containers
    - patchType: JSONPatch
      jsonPatch:
        expression: |
          variables.podSpec.containers.map(c, 
            JSONPatch{
              op: "add",
              path: variables.podSpecPath + "/containers/" + string(variables.podSpec.containers.indexOf(c)) + "/securityContext/capabilities",
              value: dyn({"drop": dyn(["ALL"])})
            }
          )
    
    # Mutation 5: Set allowPrivilegeEscalation=false for all containers
    - patchType: JSONPatch
      jsonPatch:
        expression: |
          variables.podSpec.containers.map(c, 
            JSONPatch{
              op: "add",
              path: variables.podSpecPath + "/containers/" + string(variables.podSpec.containers.indexOf(c)) + "/securityContext/allowPrivilegeEscalation",
              value: dyn(false)
            }
          )