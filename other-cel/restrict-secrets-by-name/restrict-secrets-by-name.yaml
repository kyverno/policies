apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: restrict-secrets-by-name
  annotations:
    policies.kyverno.io/title: Restrict Secrets by Name in CEL expressions
    policies.kyverno.io/category: Other in CEL 
    policies.kyverno.io/subject: Pod, Secret
    kyverno.io/kyverno-version: 1.11.0
    kyverno.io/kubernetes-version: "1.26-1.27"
    policies.kyverno.io/description: >-
      Secrets often contain sensitive information and their access should be carefully controlled.
      Although Kubernetes RBAC can be effective at restricting them in several ways,
      it lacks the ability to use wildcards in resource names. This policy ensures
      that only Secrets beginning with the name `safe-` can be consumed by Pods.
      In order to work effectively, this policy needs to be paired with a separate policy
      or rule to require `automountServiceAccountToken=false` since this would otherwise
      result in a Secret being mounted.
spec:
  background: false
  validationFailureAction: Audit
  rules:
  - name: safe-secrets-from-env
    match:
      any:
      - resources:
          kinds:
          - Pod
    validate:
      cel:
        variables:
          - name: allContainers
            expression: "(object.spec.containers + (has(object.spec.initContainers) ? object.spec.initContainers : []) + (has(object.spec.ephemeralContainers) ? object.spec.ephemeralContainers : []))"
        expressions: 
          - expression: >-
              variables.allContainers.all(container, 
              !has(container.env) || container.env.all(env,
              !has(env.valueFrom) || !has(env.valueFrom.secretKeyRef) || env.valueFrom.secretKeyRef.name.startsWith("safe-")))
            message: "Only Secrets beginning with `safe-` may be consumed in env statements."
  - name: safe-secrets-from-envfrom
    match:
      any:
      - resources:
          kinds:
          - Pod
    validate:
      cel:
        variables:
          - name: allContainers
            expression: "(object.spec.containers + (has(object.spec.initContainers) ? object.spec.initContainers : []) + (has(object.spec.ephemeralContainers) ? object.spec.ephemeralContainers : []))"
        expressions: 
          - expression: >-
              variables.allContainers.all(container, 
              !has(container.envFrom) || container.envFrom.all(env,
              !has(env.secretRef) || env.secretRef.name.startsWith("safe-")))
            message: "Only Secrets beginning with `safe-` may be consumed in envFrom statements."
  - name: safe-secrets-from-volumes
    match:
      any:
      - resources:
          kinds:
          - Pod
    validate:
      cel:
        expressions:
          - expression: >-
              !has(object.spec.volumes) || object.spec.volumes.all(volume,
              !has(volume.secret) || volume.secret.secretName.startsWith("safe-"))
            message: "Only Secrets beginning with `safe-` may be consumed in volumes."

