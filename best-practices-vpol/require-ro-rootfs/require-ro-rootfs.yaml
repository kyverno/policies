apiVersion: policies.kyverno.io/v1alpha1
kind: ValidatingPolicy
metadata:
  name: require-ro-rootfs
  annotations:
    policies.kyverno.io/title: Require Read-Only Root Filesystem in VPOL
    policies.kyverno.io/category: Best Practices, EKS Best Practices, PSP Migration in VPOL 
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    kyverno.io/kubernetes-version: "1.30"
    policies.kyverno.io/minversion: 1.14.0
    policies.kyverno.io/description: >-
      A read-only root file system helps to [Deny] an immutable infrastructure strategy;
      the container only needs to write on the mounted volume that persists the state.
      An immutable root filesystem can also prevent malicious binaries from writing to the
      host system. This policy validates that containers define a securityContext
      with `readOnlyRootFilesystem: true`.
spec:
  validationActions: [Audit]
  evaluation: 
     background: 
           enabled: true
  matchConstraints:
        resourceRules:
          - apiGroups: ['']
            apiVersions: [v1]
            operations: [CREATE, UPDATE]
            resources: [pods]
  validations:
          - expression: >-
              object.spec.containers.all(container,
              container.?securityContext.?readOnlyRootFilesystem.orValue(false) == true)
            message: "Root filesystem must be read-only."
          
